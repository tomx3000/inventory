

{%extends 'home/base.html'%}

{%block style%}

{%endblock%}
{%block inputsearch%}

   <div id="searchorderauthorize">
    
    <nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow row ">
      <a class="navbar-brand col-2 col-sm-2 col-md-2 col-lg-2  mr-0 " href="#">Oceanic : {{user.username}}
      </a>
      <input class="form-control form-control-dark col-5 col-sm-5 col-md-8 col-lg-8 w-100" type="text" placeholder="Search" aria-label="Search" v-model="searchfiledsaleauthorize" v-on:keyup.enter="getOrderauthorize">
      <button class='btn btn-outline-secondary my-2 my-sm-0 col-2 col-sm-2 col-md-1 col-lg-1' v-cloak v-on:click.prevent="getOrderauthorize()">search</button>
      <ul class="navbar-nav px-3 col-3 col-sm-3 col-md-1 col-lg-1">
        <li class="nav-item text-nowrap ">
          <a class="nav-link" href="/login/">Sign out</a>
        </li>
      </ul>
    </nav>

  </div>
    {%endblock%}


{%block content%}
<div id="authorize">


	<h1 v-cloak> Tsh [[totalsale]]</h1>

		<table class="table">
  <thead>
    <tr>
      <th scope="col">No</th>
      <th scope="col">Date</th>
      <th scope="col">Seller</th>
      <th scope="col">Customer</th>
<!--       <th scope="col">Issuer</th>
 -->      <th scope="col">Product Name</th>
      <th scope="col">Quantity</th>
      <th scope="col">Cost</th>
      <th scope="col">Status</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr v-for="sale in computesales" v-if="!sale.sales_authorized" v-cloak>
      <th scope="row" v-cloak>[[sale.id]]</th>
      <td v-cloak> [[parseDate(sale.created_at)]] </td>
      <td v-cloak v-for="user in users" v-if="user.id==sale.user"> <span v-for="employee in employees" v-if="employee.user == user.id" v-cloak>
      	[[employee.employee_firstname]]
      </span>
      </td>
      <td v-cloak v-for="customer in customers" v-if="sale.customer == customer.id">  [[customer.customer_name]]</td>
<!--       <td v-cloak>  Issuer</td>
 -->      <td v-if="item.id == sale.item" v-for ="item in items" v-cloak>[[item.item_name]]</td>
      <td v-cloak>[[sale.sales_quantity]]</td>
      <td v-cloak>[[sale.sales_amount]]</td>
	  <td v-cloak v-if="sale.sales_received && !sale.sales_authorized"> <button class="btn btn-small btn-dark" v-on:click="authorizeSale(sale.id)">Authorize</button></td>
	  <td v-cloak v-if="!sale.sales_received && !sale.sales_authorized"> Pending ....</td>
      <td>
      	<button type="button" class="close" aria-label="Close" v-on:click="deleteSale(sale.id)">

	              <span aria-hidden="true">&times;</span>
				  </button>
      </td>
    </tr>

  </tbody>
</table>

</div>
{%endblock%}

{%block script%}
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/moment.min.js"></script>
 <script>
    moment().format();
</script>
  <script >
//   searchorderauthorize
// searchfiledsaleauthorize
// getOrderauthorize
new Vue({
  delimiters: ['[[', ']]'],
  el: '#searchorderauthorize',
  data:{
  	searchfiledsaleauthorize:'',
  },methods:{
  	getOrderauthorize:function(){
  		let api_url='/api/sale';
      if(this.searchfiledsaleauthorize!==''||this.searchfiledsaleauthorize!==null){
        api_url='/api/sale/?search='+this.searchfiledsaleauthorize;
      }

     this.$http.get(api_url)
     .then(function(response){

      vmauth.sales=response.data
        vmauth.totalsale=vmauth.getToatalSales(vmauth.sales)
      // this.alertOnMininumIrem(this.items)
     })
     .catch(function(error){
      this.title='error getting items'
     })

  	}
  }

  })

 vmauth= new Vue({
  	delimiters: ['[[', ']]'],
  	el: '#authorize',
  	data:{
  		totalsale:'',
  		title:'',
  		sales:'',
  		user:'',
  		items:'',
  		customers:'',
  		employees:'',
  		users:'',
  	},
  	methods:{
  		  	getSales:function(){
  		this.title='fetching data'
  		// note :
  		// this function is modified to get all sales objeects regardless of the user requesting this object
  		 this.$http.get('/api/sale')
  		 .then(function(response){
  		 	this.sales=response.data
  		 	this.title='data fetched'
  		 	// this.user= response.data.userid
  		 	// alert("welcome")
  		 	// this.totalacceptsale=this.getTotalAcceptSales(this.sales)
  		 	this.totalsale=this.getToatalSales(this.sales)
  		 })
  		 .catch(function(error){
  		 	this.title='error getting salse'
  		 })
  	},
  	deleteSale:function(id){
  		 this.$http.delete('/api/sale/'+id+'/')
  		 .then(function(response){
  		 	// this.items=response.data
  		 	this.title=response.data
  		 	this.getSales()
  		 	// alert('response')
  		 })
  		 .catch(function(error){
  		 	this.title='error getting items'
  		 })

  	},
  		getToatalSales:function(sales){

  		var amount=0;  	
		$.each(sales,function(key, value) {
			     if(value.sales_received && !value.sales_authorized){
			     	amount+=value.sales_amount
				     }
				 });
		
		return amount;
  	},
    getUserid:function(){
      this.$http.get('/api/company')
     .then(function(response){
      // this.company=response.data.serial
      this.user=response.data.userid
      
     })
     .catch(function(error){
      this.title='error getting items'
     })
    }
	,
  	getItems:function(){
		 this.$http.get('/api/item')
		 .then(function(response){
		 	this.items=response.data
		 })
		 .catch(function(error){
		 	this.title='error getting items'
		 })
  	},
  	getUsers:function(){
		 this.$http.get('/api/user')
		 .then(function(response){
		 	this.users=response.data
		 })
		 .catch(function(error){
		 	this.title='error getting items'
		 })
  	},
  	getEmployees:function(){
		 this.$http.get('/api/employee')
		 .then(function(response){
		 	this.employees=response.data
		 })
		 .catch(function(error){
		 	this.title='error getting items'
		 })
  	},
  	getCustomers:function(){
		 this.$http.get('/api/customer')
		 .then(function(response){
		 	this.customers=response.data
		 })
		 .catch(function(error){
		 	this.title='error getting items'
		 })
  	},
  		authorizeSale:function(id){
  		this.$http.post('/authorizesale/'+id+'/',{'id':id})
  		 .then(function(response){
  		 	// this.items=response.data
  		 	this.title=response.data
	  		this.getSales()
	  		this.getItems()
	  		this.getUsers()
	  		this.getEmployees()
			this.getCustomers()
  		 	// alert('response')
  		 })
  		 .catch(function(error){
  		 	this.title='error getting items'
  		 })

  	},parseDate:function(date){

  	return moment(date).format('LLLL');

  	},

  	},
  	computed:{
  		computesales:function(){

  		this.title='fetching data'
  		// note :
  		// this function is modified to get all sales objeects regardless of the user requesting this object
  		 this.$http.get('/api/sale/'+1)
  		 .then(function(response){
  		 	this.sales=response.data.serial
  		 	this.title='data fetched'
  		 	this.user= response.data.userid
  		 	// alert("welcome")
  		 	// this.totalacceptsale=this.getTotalAcceptSales(this.sales)
  		 	this.totalsale=this.getToatalSales(this.sales)
  		 })
  		 .catch(function(error){
  		 	this.title='error getting salse'
  		 })

  			return this.sales;
  		}

  	},
  	beforeMount(){
  		this.getUserid()
  		this.getSales()
  		this.getItems()
  		this.getUsers()
  		this.getEmployees()
		this.getCustomers()

  	}
  })

  </script>
{%endblock%}